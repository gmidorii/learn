# Go実装の最適化ゲーム

## 概要
同僚がこのコード書ける `Java` のライブラリない？と言ってきたので、  
`Go` で実装し返しました。(遊び)  
書いたコードがひどそうだったので、最適化をするゲームをしてみました。  

## お題
配列が与えられた際に、最小/最大サイズの文字列を前から順に結合して取得したい
とのことでした。(何言ってるかわからない)

### 例
例を挙げるとわかりやすいかと思います。  
input: [a, b, c, d, e]  
=> output: [ab abc abcd abcde bc bcd bcde cd cde de]  

## 実装
### パート1
まず、最初に思いついて書いたコードが下記になります。  
なんかこう色々まずそうです。  
[Go Playground](https://play.golang.org/p/_oj1H3CRzb)
```go
func merge(arr []string) string {
	var s string
	for _, v := range arr {
		s += v
	}
	return s
}

func initialShingle(min, max int, arr []string) []string {
	res := []string{}
	if min > max {
		return res
	}

	for i := 0; i < len(arr); i++ {
		cmin := min
		for j := i; j+cmin < len(arr)+1; j++ {
			if len(arr[i:j+cmin]) > max {
				break
			}
			res = append(res, merge(arr[i:j+cmin]))
		}
	}
	return res
}
```

### 閑話休題
とりあえず、動作確認のためテストコードを書きます。  
min/maxの値の境界値等を `Table Drive Test` で記載しました。
https://github.com/midorigreen/shingle/blob/master/main_test.go#L35
```go
var cases = []struct {
	in  in
	out []string
}{
	{
		in:  in{min: 2, max: 1, arr: []string{"a", "b", "c", "d", "e"}},
		out: []string{},
	},
	{
		in:  in{min: 2, max: 2, arr: []string{"a", "b", "c", "d", "e"}},
		out: []string{"ab", "bc", "cd", "de"},
	},
	{
		in:  in{min: 2, max: 5, arr: []string{"a", "b", "c", "d", "e"}},
		out: []string{"ab", "abc", "abcd", "abcde", "bc", "bcd", "bcde", "cd", "cde", "de"},
	},
	{
		in:  in{min: 2, max: 100, arr: []string{"a", "b", "c", "d", "e"}},
		out: []string{"ab", "abc", "abcd", "abcde", "bc", "bcd", "bcde", "cd", "cde", "de"},
	},
}

func TestInitialShingle(t *testing.T) {
	for _, c := range cases {
		res := initialShingle(c.in.min, c.in.max, c.in.arr)
		equal(t, res, c.out)
	}
}
```

ベンチマークも書いたので、この結果が元になります。  
```sh
% go test -benchmem -run=^$ github.com/midorigreen/shingle -bench ^BenchmarkInitialShingle$

goos: darwin
goarch: amd64
pkg: github.com/midorigreen/shingle
BenchmarkInitialShingle-4   	       3	 482380505 ns/op	354790944 B/op	 4621679 allocs/op
PASS
ok  	github.com/midorigreen/shingle	2.735s
Success: Benchmarks passed.
```

### パート2
alloc回数を減らすために、返却値の初期化を1回にします。  
[Go Playground](https://play.golang.org/p/Y-o0etalwF)
```go
func shingle2(min, max int, arr []string) []string {
	// 省略

	// for alloc array
	maxLen := len(arr)
	resLen := 0
	for maxLen > 0 {
		resLen += maxLen
		maxLen--
	}
	res := make([]string, resLen)

	// 省略
}
```

ベンチマーク結果
```sh
% go test -bench . -benchmem
goos: darwin
goarch: amd64
pkg: github.com/midorigreen/shingle
BenchmarkInitialShingle-4              3         364788315 ns/op        354790757 B/op   4621679 allocs/op
BenchmarkShingle2-4                    3         484458838 ns/op        355455082 B/op   4621651 allocs/op
PASS
ok      github.com/midorigreen/shingle  4.093s
```
悪くなってますね..  

### パート3
slice->stringの処理で文字列結合をしている部分を修正しました。  
`strings.Join([]string, string)` を使ってます。  
[Go Playground](https://play.golang.org/p/s009mJXiGG)
```go
func shingle3(min, max int, arr []string) []string {
	// 省略

			res = append(res, strings.Join(arr[i:j+cmin], ""))

	// 省略
}
```

ベンチマーク
```
% go test -bench . -benchmem                                                                                                               (minikube/default)
goos: darwin
goarch: amd64
pkg: github.com/midorigreen/shingle
BenchmarkInitialShingle-4              5         330830989 ns/op        354791379 B/op   4621680 allocs/op
BenchmarkShingle2-4                    5         332415947 ns/op        355455014 B/op   4621651 allocs/op
BenchmarkShingle3-4                   20          59744819 ns/op        27479328 B/op     186132 allocs/op
PASS
ok      github.com/midorigreen/shingle  7.958s
```
速度もalloc回数も改善されました。