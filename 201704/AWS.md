# AWS

## IAM (Identity and Access Management)
- 使用料無料
- IAMユーザー : 認証
  - AWSアカウントに紐づくユーザー
  - 個別のアクセスキーを作成できる
  - AWSのアクセスキーを取得するために作成したりもする
  - デフォルトでは何にもアクセスできない
  - IAMグループにまとめてポリシーをアタッチする
- IAMポリシー : 承認
  - 許可されているアクションは何かの定義
  - ユーザーベースポリシー
    - ユーザーがアクセスできるリソースを定義
  - リソースベースポリシー
    - 許可されるアクションと、影響を受けるリソースを指定
    - リソースへアクセスできるユーザーも合わせて定義
    - Principalエレメントを利用
  - ポリシー(JSON)は最適化変換をされる可能性があるため文字列比較をしない
  - Actions, Resources, Effect
- IAMロール : 委任
  - アクションおよびリソースへのアクセスを許可する一連のアクセス権限
  - 利用可能者
    - ロールと同じAWSアカウントのIAMユーザー
    - ロールと異なるAWSアカウントのIAMユーザー →　これにより異なるアカウントからアクセスできるようにする
  - 委任するために
    - IAMロールに2つのポリシーをアタッチ
      - アクセス権限ポリシー(どのリソースにアクセス許可をさせるか) and 信頼ポリシー(どのアカウントに委任させるか)
    - 別アカウントのIAMユーザーにロールを引き受けられるアクセス制限ポリシーをアタッチ
  - ロールを受けると一時的にもとのアクセス権限は失う
- Principal
  - アクションを実行してリソースにアクセスできるエンティティ
  - root, IAMユーザー, IAMロールを設定できる
- アクセスキー
  - AWS CLIを使用するために利用する
  - コンソールで作成
  - `aws configure` を実行して、AccessKeyとSecretAccessKeyをセット
  - IAMユーザーのポリシーに則りアクセスできる
- AWS CloudTrailにてすべての動作が記録されている

## EC2(Elastic Compute Cloud)
- 仮想コンピューティング: インスタンス
- インスタンスストアボリューム
  - 一時データ用のストレージボリューム
  - 停止・削除で消える
- EBS(Elastic Block Store)
  - 永続的なストレージボリューム
- セキュリティグループを利用してインスタンスのアクセス制限
- タグ
- インスタンス購入オプション
  - オンデマンドインスタンス
    - 時間課金
  - リザーブドインスタンス
    - 低額の一括前払い
  - スポットインスタンス
    - 特定のインスタンスタイプを使用したい最大料金を設定
    - 最大料金を超える場合インスタンスはシャットダウン
    - オークション制
- 各タイプによってインスタンス数の制限がある
  - https://aws.amazon.com/jp/ec2/faqs/#How_many_instances_can_I_run_in_Amazon_EC2
- インスタンスタイプ
  - T2
    - バーストパフォーマンスインスタンス
    - 暇な時にCPU クレジットを蓄積
    - アクティブなときに CPU クレジットを使用
    - CPUクレジットを使い切るとベースラインまで下がるため性能が落ちる
  - M4
    - 最新世代の汎用インスタンス
    - デフォルトでEBS最適化
    - 専有EBS帯域有り
  - M3
    - 汎用インスタンス
    - 高速な I/O パフォーマンスのための SSD ベースのインスタンスストレージ
    - 専有EBS帯域なし
  - C4
    - コンピューティング最適化インスタンス
    - 高性能プロセッサー持ち
    - デフォルトでEBS最適化
    - 専有EBS帯域有り
  - C3
    - コンピューティング最適化インスタンス
    - SSDベースのインスタンスストレージ
    - 専有EBS帯域なし
  - メモリ最適化
    - X1, R4, R3
  - Accelerated Computing インスタンス
    - P2, G2, F1
  - ストレージ最適化
    - I3, D2
  - key pair
    - 基本的にキーペアでのみ(SSH)ログイン可能

## Amazon Linux
### 特徴
- AWS APIツールとCloudInitがインストール
- SSH キーペアの使用およびリモートルートログインの無効化
- Message of the Dayでアップデート通知

### CentOsとの違い
- RedHat系のディストリビューション
- バージョニングはYYYY.MM
- 常に最新版にアップデートされる
  - yumの設定ファイルを修正することで固定可能
- /opt/aws 以下にツールを一通りインストールされている
- aws cliもyumでupdateできる
- cloud-initが初期インストール
  - UserDataに設定したOSの設定情報を自動で起動時に反映してくれるツール
  - (CentOS7もcloud-init初期インストール) 
- SELinux無効
- デフォルトユーザー
  - AmazonLinux: ec2-user
  - CentOS7: centos

### EBS
- ブロックレベルのストレージボリューム
- データにすばやくアクセスする必要があり、長期永続性が必要な場合に推奨
- スナップショット
  - 増分バックアップ
  - 最初は時間がかかる
  - 暗号化可能
  - 最新のスナップショットさえあればボリュームを復元

### UserData
- EC2起動時に実行するコマンド群を定義できる
- 定義方法
  - シェルスクリプト
  - cloud-init
- シェルスクリプト実行
  - rootユーザーで実行される
  - `sudo` は不要
  - ユーザーフィードバックが必要なコマンドは実行できない
  - `/var/log/cloud-init-output.log` にログが出力される
  - `#!/bin/bash` で始める必要あり
- cloud-init
  - .ssh/authorized_keysec2-user ファイルを設定
  - [cloud-init Documentation][http://cloudinit.readthedocs.io/en/latest/index.html]
  - `#cloud-config` と先頭に記載
